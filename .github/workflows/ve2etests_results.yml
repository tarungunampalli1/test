# Report E2E Results
name: ve2etests-results

on:
  workflow_call:
    inputs:
      bypass-e2e:
        description: true if bypass-e2e label is applied
        required: true
        type: boolean
      e2e-passed:
        description: true is e2e passed successful
        required: true
        type: boolean

jobs:
  # Reporter for non-bypassed case
  report-test-results:
    name: E2E Results
    runs-on: ubuntu-latest
    steps:
      # wait for blocking review
      - uses: fountainhead/action-wait-for-check@v1.2.0
        name: Wait for Bypass E2E Review
        id: wait-for-block-on-review
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          checkName: 'block-on-review'
          intervalSeconds: 60
          timeoutSeconds: 86400 # 24 hours
          ref: ${{ github.event.pull_request.head.sha || github.sha }}
        # not bypassed and e2e passed
      - if: ${{ !inputs.bypass-e2e && inputs.e2e-passed }}
        run: echo 'E2E Passed'
        # not bypassed and e2e failed
      - if: ${{ !inputs.bypass-e2e && !inputs.e2e-passed }}
        run: |
          echo 'E2E Failed'
          exit 1
        # bypassed and approved
      - if: ${{ inputs.bypass-e2e && steps.wait-for-block-on-review.outputs.conclusion == 'success' }}
        run: echo 'E2E Bypass Approved'
        # bypassed and not approved
      - if: ${{ inputs.bypass-e2e && steps.wait-for-block-on-review.outputs.conclusion != 'success' }}
        run: |
          echo 'E2E Bypass Not Approved within 24 hours. Please rerun the workflow to re-request approval.'
          exit 1
